name: Build Android APK

on:
  push:
    branches:
      - main
      - 'release/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Make Gradle executable
        run: chmod +x ./gradlew

      - name: Create google-services.json placeholder
        run: |
          mkdir -p app/src
          echo '{
            "project_info": {
              "project_number": "YOUR_PROJECT_NUMBER",
              "project_id": "YOUR_PROJECT_ID",
              "storage_bucket": "YOUR_BUCKET.appspot.com"
            },
            "client": [{
              "client_info": {
                "mobilesdk_app_id": "1:YOUR_PROJECT_NUMBER:android:YOUR_APP_ID",
                "android_client_info": {
                  "package_name": "com.callmenot.app"
                }
              },
              "api_key": [{"current_key": "YOUR_API_KEY"}],
              "services": {
                "appinvite_service": {
                  "other_platform_oauth_client": []
                }
              }
            }],
            "configuration_version": "1"
          }' > app/google-services.json

      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: callmenot-debug
          path: app/build/outputs/apk/debug/*.apk

  build-release:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/')
    needs: build
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Make Gradle executable
        run: chmod +x ./gradlew

      - name: Decode Keystore
        if: ${{ env.BASE64_KEYSTORE != '' }}
        env:
          BASE64_KEYSTORE: ${{ secrets.BASE64_KEYSTORE }}
        run: |
          echo "$BASE64_KEYSTORE" | base64 --decode > keystore.jks

      - name: Create google-services.json from secret
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          if [ -n "$GOOGLE_SERVICES_JSON" ]; then
            echo "$GOOGLE_SERVICES_JSON" > app/google-services.json
          else
            echo "Warning: GOOGLE_SERVICES_JSON secret not set, using placeholder"
            echo '{
              "project_info": {"project_number": "0", "project_id": "placeholder"},
              "client": [{"client_info": {"mobilesdk_app_id": "1:0:android:0", "android_client_info": {"package_name": "com.callmenot.app"}}, "api_key": [{"current_key": "placeholder"}]}],
              "configuration_version": "1"
            }' > app/google-services.json
          fi

      - name: Build Release APK
        env:
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew assembleRelease --stacktrace

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: callmenot-release
          path: app/build/outputs/apk/release/*.apk

      - name: Create Release
        if: startsWith(github.ref, 'refs/heads/release/')
        uses: softprops/action-gh-release@v1
        with:
          files: app/build/outputs/apk/release/*.apk
          tag_name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
